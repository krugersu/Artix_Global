Общее описание
==============


Документация по блоку обмена между Artix и УНФ в части выгрузки остатков из УНФ в кассовый сервер Artix и загрузки кассовых смен и продаж в УНФ.
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""


Связь между 1С и Artix осуществляется с помощью Http-сервисов реализованных на стороне :term:`УНФ`. Данные по продажам 1С забирает из базы данных
Кассового сервера с помощью Sql запросов. Таблицы из БД Кассового сервера подключены в УНФ в качестве внешнего источника данных.
Прокси сервер реализован на Python и располагается на отдельном сервере с Linux. 

.. figure:: images/gl.png


Работа происходит следующим образом:
В :term:`УНФ` в справочнике "крю_Настройки" в предопределенном реквизите "КаталогКонтроляОбменаArtix" хранится путь до каталога интеграции
с Artix, который имеет следующую структуру - 

.. figure:: images/cat.png

При проведении документа товародвижения срабатывает расширение "крюВыгрузкаАртикс", которое проверяет интерактивоное проведение документа или нет и в случае
интерактивного проведения в каталоге соответствующем номеру магазина создается файл-флаг
вида:  "1681466893_chg", где число это псевдослучайное число образованное разностью дат, для достижения уникальности имени файла.

Номенклатура относящаяся к кулинарии (категория номенклатуры "Кулинария"), выгружается с **пустым** полем остатка, так как всегда продается в минус. Устанавливать
поле остатка в "0" нельзя, так Artix считает это за остаток равный "0" и соответственно не дает продавать. 

.. Important::

    У номенклатуры для выгрузки в Artix должна быть установлена цена, остаток больше нуля или пустой (для кулинарии), штрихкод с установленной единицой измерения,
    единица измерения упаковки. При отсутствии какого-то из перечисленных свойств, позиция номенклатуры не выгрузится в Artix

Программа :term:`Brocker` запускаясь с указанной настройкой сервера периодичностью начинает обрабатывать кассовые смены.
Вначале в :term:`УНФ` передаются данные по вновь открытым сменам в Artix. :term:`УНФ` получая информацию создает новые документы "Кассовая смена" со статусом
"Открытая" и автоматом создается документ "ОРП" у которого заполнена только шапка и имеется ссылка на кассовую смену.
После этого :term:`Brocker` отправляет информацию по закрытым кассовым сменам. УНФ заполняет оставшиеся реквизиты в документе "Кассовая смены" и присваевает 
документу статус "Закрыта (чеки за архивированы)".
Далее согласно созданному в УНФ расписанию запускается обработка по формированию "ОРП". Данные для заполнения табличных частей "ОРП" берутся запросом из
кассового сервера, таблицы которого подключены в 1С в качестве внешнего источника данных.

Далeе программа прокси  отправляет запрос ("GetChangeShop") в УНФ для получения номеров магазинов по которым были изменения остатков в ту 
или иную сторону. :term:`УНФ` "просматривает" каталоги в папке интеграции и возвращает список номеров магазинов в каталогах которых, были обнаружены
файлы флаги.
Затем программа :term:`Brocker` перебирая номера магазинов формирует в УНФ запрос остатков по каждому. Получив остатки, :term:`Brocker` обрабатывает данные - 
для номенклатуры с аналогами переносит суммируя все остатки на головную номенклатуру, а аналоги удаляет из выгрузки, таким образом на кассы падает в остатках, только
головная номенклатура.
После формирования остатков, на основе этих данных формируется файл формата :term:`aif` и выгружается в соответствующим каталог магазина. 
Кассовый сервер через определенное время "забирает" файл и формирует номенклатуру с остатками на магазине.


.. todo:: 
    Планируется добавить модуль контроля товаро-остатков пришедших из :term:`УНФ` и выгруженных в кассовый сервер


