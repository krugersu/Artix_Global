Общее описание
==============


Документация по блоку обмена между Artix и УНФ в части выгрузки остатков из УНФ в кассовый сервер Artix и загрузки кассовых смен и продаж в УНФ.
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""


Связь между 1С и Artix осуществляется с помощью Http-сервисов реализованных на стороне УНФ. Данные по продажам 1С забирает из базы данных
Кассового сервера с помощью Sql запросов. Таблицы из БД Кассового сервера подключены в УНФ в качестве внешнего источника данных.
Прокси сервер реализован на Python и располагается на отдельном сервере с Linux. 

.. figure:: images/gl.png


Работа происходит следующим образом:
В УНФ в справочнике "крю_Настройки" в предопределенном реквизите "КаталогКонтроляОбменаArtix" хранится путь до каталога интеграции
с Artix, который имеет следующую структуру - 

.. figure:: images/cat.png

При проведении документа товародвижения срабатывает подписка на событие и в каталоге соответствующем номеру магазина создается файл-флаг
вида:  "1681466893_chg", где число это псевдослучайное число образованное разностью дат, для достижения уникальности имени файла.


Программа Brocker запускаясь с указанной настройкой сервера переодичнойстью начинает обрабатывать кассовые смены.
Вначале в УНФ передаются данные по вновь открытым сманам в Artix. УНФ получая информацию создает новые документы "Кассовая смена" со статусом
"Открытая" и автоматом создается документ "ОРП" у которого заполнена только шапка и имеется ссылка на кассовую смену.
После этого Brocker отправляет информацию по закрытым кассовым сменам. УНФ заполняет оставшиеся реквизиты в документе "Кассовая смены" и присваевает 
документу статус "Закрыта (чеки заархивированы)".
Далее согласно созданному в УНФ расписанию запускается обработка по формированию "ОРП". Данные для заполнения табличных частей "ОРП" берутся запросом из
кассового сервера, таблицы которого подключены в 1С в качестве внешнего источника данных.

Далле программа прокси  отправляет запрос ("GetChangeShop") в УНФ для получения номеров магазинов по которым были изменения остатков в ту 
или иную сторону. УНФ "просматривает" каталоги в папке интеграции и возвращает список номеров магазинов в каталогах которых, были обнаружены
файлы флаги.
Затем программа Brocker перебирая номера магазинов формирует в УНФ запрос остатков по каждому. Получив остатки, Brocker обрабатывает данные - 
для номенклатуры с аналогами переносит суммируя все остатки на головную номенклатуру, а аналоги удаляет из выгрузки, таким образом на кассы падает в остатках, только
головная номенклатура.

.. todo:: Fix this


